# OnGoingPatients
This service keeps track of the patients currently in the emergency room and saves their data as they leave. It listens
to topic `elvisDiff` and applies the diffs to the patients in an `elasticsearch`. This includes the raw data from the
Elvis clients but also a few analysed fields, mainly time measurements.

To work it needs to be paired with a running instance of `Transformationservice`.

## Startup sequence
Make sure `application.conf` is setup correctly. It needs to point to a proper `activemq` and `elasticsearch`.

Now run `OnGoingPatients`. When it reports that it is connected to the bus, run `Transformationservice`. If it is
already running, restart it. On startup it will output all the current patients as `elvisDiff` of type `newLoad`, which
are sent to the database by OnGoingPatients. Note that any patient loaded through `newLoad` will be missing the
history of any data that was changed before the load.

## Database Structure
Patients that are currently in the emergency room will be indexed under
`/on_going_patients_index/patient_type/CareContactId`, where `CareContactId` is the anonymised id stored in the patient.
Patients that are removed from Elvis are moved to `/finished_patients_index/patient_type/CareContactId`

We have three ways of indexing our patients. We only use CareContactId.
`CareContactId: BigInt`
`PatientId: BigInt`
`VisitId: BigInt`

These are actual fields in Elvis
`DepartmentComment: String`
`Location: String`
`ReasonForVisit: String`
`Team: String`

These timestamps are almost always identical
`CareContactRegistrationTime: DateTime`
`VisitRegistrationTime: DateTime`

`Events: List[ElvisEvent]`, the list of ElvisEvents that has happened with the patient. ElvisEvents are generated by the drag-and-drop folders in Elvis.
`{
    "CareEventId": 3224235,
    "Category": "T",
    "End": "2016-05-02T13:30:00Z",
    "Start": "2016-05-02T13:30:00Z",
    "Title": "Triage",
    "Type": "TRIAGE",
    "Value": "TRIAGE",
    "VisitId": 3393245
}`

`Updates: List[ElvisUpdateEvent]`, list of updates of the fields in Elvis. An update is of the format:
`{
    "Timestamp": "2016-03-11T23:59:00Z",
    "ModifiedField": "Location",
    "ModifiedTo": "52"
}`

`Priority: String`, one of ["", "blå", "grön", "gul", "orange", "röd"]. This is not an actual field in Elvis, instead it 
is copied from the ElvisEvent:"Priority" with the latest timestamp.

`TimeToDoctor: BigInt`, the time between VisitRegistrationTime and ElvisEvent:"Läkare". If there is no "Läkare" event, this 
is set to -1. If a doctor was assigned before the registration, this is set to 0.
`TimeToTriage: BigInt`, the time between VisitRegistrationTime and ElvisEvent:"Triage", If there is no Triage event, this 
is set to -1. If triage took place before the registration, this is set to 0.
Finished patients also contain:
`RemovedTime: DateTime`, the timestamp of the removal
`TotalTime:    BigInt`, the time between VisitRegistrationTime and removedTime.